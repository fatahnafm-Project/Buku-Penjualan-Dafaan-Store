<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldenSales v5.5 - Professional Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .navy-bg { background-color: #001F3F; }
        .gold-text { color: #D4AF37; }
        .gold-border { border-color: #D4AF37; }
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #B8860B 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0,31,63,0.1); }
        .progress-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="pb-12">

    <nav class="navy-bg p-5 border-b-4 gold-border sticky top-0 z-50 shadow-xl">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="header-font text-2xl text-white tracking-widest uppercase">Golden<span class="gold-text">Sales</span> <span class="text-[10px] opacity-60">Analytics v5.5</span></h1>
            <div class="flex items-center gap-3">
                <select id="periodeAnalisis" onchange="renderApp()" class="p-2 rounded bg-blue-900 text-white text-xs border border-blue-700 outline-none">
                    <option value="hari">Hari Ini</option>
                    <option value="minggu">7 Hari Terakhir</option>
                    <option value="bulan">30 Hari Terakhir</option>
                </select>
                <button onclick="exportPDF()" class="gold-gradient text-navy-bg px-5 py-2 rounded-full font-bold text-xs uppercase shadow-lg hover:scale-105 transition">Export PDF</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="inventoryDisplay"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-2xl card-shadow p-6 border border-gray-100 flex flex-col justify-between">
                <h2 class="text-navy-bg text-[10px] font-black uppercase tracking-widest mb-6 border-b pb-2 text-center">Business Health Rates</h2>
                <div class="space-y-6">
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-bold uppercase text-gray-400"><span>HPP Rate</span><span id="hppRateTxt" class="text-amber-600">0%</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden"><div id="hppBar" class="progress-bar bg-amber-500 h-full" style="width: 0%"></div></div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-bold uppercase text-gray-400"><span>Ops Rate</span><span id="opsRateTxt" class="text-indigo-600">0%</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden"><div id="opsBar" class="progress-bar bg-indigo-500 h-full" style="width: 0%"></div></div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-bold uppercase text-gray-400"><span>Net Margin</span><span id="profitRateTxt" class="text-emerald-600">0%</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden"><div id="profitBar" class="progress-bar bg-emerald-500 h-full" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white rounded-2xl card-shadow p-6 border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-navy-bg text-[10px] font-black uppercase tracking-widest">Revenue vs Ops vs Profit Trend</h2>
                    <div class="flex gap-3 text-[8px] font-bold uppercase">
                        <span class="flex items-center"><span class="w-2 h-2 bg-amber-500 rounded-full mr-1"></span> Omzet</span>
                        <span class="flex items-center"><span class="w-2 h-2 bg-indigo-500 rounded-full mr-1"></span> Ops</span>
                        <span class="flex items-center"><span class="w-2 h-2 bg-emerald-500 rounded-full mr-1"></span> Profit</span>
                    </div>
                </div>
                <div class="h-[200px]"><canvas id="lineChartAnalytics"></canvas></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white rounded-2xl card-shadow overflow-hidden h-fit border border-gray-100">
                <div class="navy-bg p-4 flex justify-between items-center">
                    <h2 class="text-white text-xs font-bold uppercase tracking-widest">Input Penjualan</h2>
                    <button onclick="document.getElementById('modalStok').classList.toggle('hidden')" class="text-[10px] gold-text font-bold underline">ISI GUDANG</button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="date" id="inpTgl" class="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none">
                    <select id="inpKategori" class="w-full p-3 bg-amber-50 border border-amber-200 rounded-xl text-sm font-bold outline-none">
                        <option value="Tas">Tas</option><option value="Dompet">Dompet</option><option value="Paket">Paket</option><option value="Lainnya">Lainnya</option>
                    </select>
                    <input type="text" id="inpNama" placeholder="Nama Produk" class="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="inpHpp" placeholder="HPP/Unit" class="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none">
                        <input type="number" id="inpJual" placeholder="Harga Jual" class="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="inpTerjual" placeholder="Qty" class="w-full p-3 border-blue-200 border rounded-xl text-sm font-bold text-blue-700">
                        <input type="number" id="inpOps" placeholder="Biaya Admin" class="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none">
                    </div>
                    <button onclick="tambahDataPenjualan()" class="w-full py-4 gold-gradient text-navy-bg font-black rounded-xl shadow-xl hover:brightness-110 uppercase text-xs">Simpan Transaksi</button>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-amber-500">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Total Omzet</p>
                        <h4 id="statOmzet" class="text-lg font-black text-navy-bg">Rp 0</h4>
                    </div>
                    <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-emerald-500">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Total Net Profit</p>
                        <h4 id="statProfitNet" class="text-lg font-black text-emerald-600">Rp 0</h4>
                    </div>
                </div>

                <div class="bg-white rounded-2xl card-shadow overflow-hidden border border-gray-100">
                    <div class="overflow-y-auto max-h-[400px]">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-[10px] text-gray-400 uppercase sticky top-0 z-10">
                                <tr><th class="p-4">Produk</th><th class="p-4">Omzet</th><th class="p-4">Ops</th><th class="p-4 text-right">Profit Net</th><th class="p-4"></th></tr>
                            </thead>
                            <tbody id="tabelBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalStok" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm space-y-4 shadow-2xl">
            <h3 class="font-bold text-navy-bg uppercase text-center border-b pb-2">Update Stok Gudang</h3>
            <select id="stokKategori" class="w-full p-3 bg-gray-50 border rounded-xl">
                <option value="Tas">Tas</option><option value="Dompet">Dompet</option><option value="Paket">Paket</option><option value="Lainnya">Lainnya</option>
            </select>
            <input type="number" id="stokTambah" placeholder="Jumlah Tambah" class="w-full p-3 border rounded-xl">
            <div class="flex gap-2">
                <button onclick="document.getElementById('modalStok').classList.add('hidden')" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold text-xs uppercase text-gray-600">Batal</button>
                <button onclick="updateStokGudang()" class="flex-1 py-3 bg-navy-bg text-white rounded-xl font-bold text-xs uppercase">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        let masterStock = JSON.parse(localStorage.getItem('goldenMasterStock')) || { "Tas": 0, "Dompet": 0, "Paket": 0, "Lainnya": 0 };
        let salesDB = JSON.parse(localStorage.getItem('goldenSalesDB_v4')) || [];
        let myLineChart = null;

        document.getElementById('inpTgl').valueAsDate = new Date();

        function formatRp(n) { return "Rp " + new Intl.NumberFormat("id-ID").format(n); }

        function updateStokGudang() {
            const kat = document.getElementById('stokKategori').value;
            const jml = parseInt(document.getElementById('stokTambah').value) || 0;
            if(jml <= 0) return alert("Jumlah salah!");
            masterStock[kat] += jml;
            localStorage.setItem('goldenMasterStock', JSON.stringify(masterStock));
            document.getElementById('stokTambah').value = "";
            document.getElementById('modalStok').classList.add('hidden');
            renderApp();
        }

        function tambahDataPenjualan() {
            const kat = document.getElementById('inpKategori').value;
            const terjual = parseInt(document.getElementById('inpTerjual').value) || 0;
            if (masterStock[kat] < terjual) return alert(`Stok ${kat} kurang! Sisa: ${masterStock[kat]}`);

            const data = {
                id: Date.now(),
                tgl: document.getElementById('inpTgl').value,
                kategori: kat,
                nama: document.getElementById('inpNama').value,
                hpp: parseFloat(document.getElementById('inpHpp').value) || 0,
                jual: parseFloat(document.getElementById('inpJual').value) || 0,
                terjual: terjual,
                ops: parseFloat(document.getElementById('inpOps').value) || 0
            };

            if(!data.nama || terjual <= 0) return alert("Lengkapi data!");
            masterStock[kat] -= terjual;
            salesDB.push(data);
            localStorage.setItem('goldenMasterStock', JSON.stringify(masterStock));
            localStorage.setItem('goldenSalesDB_v4', JSON.stringify(salesDB));
            renderApp();
            ['inpNama','inpHpp','inpJual','inpTerjual','inpOps'].forEach(i => document.getElementById(i).value="");
        }

        function renderLineChart(filteredData) {
            const ctx = document.getElementById('lineChartAnalytics').getContext('2d');
            const grouped = filteredData.reduce((acc, curr) => {
                if (!acc[curr.tgl]) acc[curr.tgl] = { omzet: 0, profit: 0, ops: 0 };
                const o = curr.jual * curr.terjual;
                const op = curr.ops * curr.terjual;
                const p = o - (curr.hpp * curr.terjual) - op;
                acc[curr.tgl].omzet += o;
                acc[curr.tgl].ops += op;
                acc[curr.tgl].profit += p;
                return acc;
            }, {});

            const labels = Object.keys(grouped).sort();
            if (myLineChart) myLineChart.destroy();
            myLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Omzet', data: labels.map(l => grouped[l].omzet), borderColor: '#D4AF37', backgroundColor: 'rgba(212, 175, 55, 0.1)', fill: true, tension: 0.4 },
                        { label: 'Ops', data: labels.map(l => grouped[l].ops), borderColor: '#6366f1', tension: 0.4 },
                        { label: 'Profit', data: labels.map(l => grouped[l].profit), borderColor: '#10b981', borderDash: [5, 5], tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { font: { size: 8 } } }, x: { ticks: { font: { size: 8 } } } } }
            });
        }

        function renderApp() {
            const invCont = document.getElementById('inventoryDisplay');
            invCont.innerHTML = "";
            for (const [kat, jml] of Object.entries(masterStock)) {
                invCont.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl card-shadow border border-gray-100 text-center">
                        <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">${kat}</p>
                        <h3 class="text-2xl font-black ${jml < 5 ? 'text-red-500' : 'text-navy-bg'}">${jml}</h3>
                    </div>`;
            }

            const periode = document.getElementById('periodeAnalisis').value;
            const now = new Date();
            const filtered = salesDB.filter(item => {
                const tglItem = new Date(item.tgl);
                const diff = Math.ceil(Math.abs(now - tglItem) / (1000*60*60*24));
                if(periode === 'hari') return item.tgl === now.toISOString().split('T')[0];
                if(periode === 'minggu') return diff <= 7;
                return diff <= 30;
            });

            const body = document.getElementById('tabelBody');
            body.innerHTML = "";
            let tO = 0, tH = 0, tOp = 0, tP = 0;

            filtered.sort((a,b) => new Date(b.tgl) - new Date(a.tgl)).forEach(item => {
                const o = item.jual * item.terjual;
                const h = item.hpp * item.terjual;
                const op = item.ops * item.terjual;
                const p = o - h - op;
                tO += o; tH += h; tOp += op; tP += p;
                body.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-4"><div class="font-bold text-navy-bg">${item.nama}</div><div class="text-[8px] text-gray-400">${item.tgl} | ${item.kategori}</div></td>
                        <td class="p-4 font-semibold">${formatRp(o)}</td>
                        <td class="p-4 text-indigo-600 font-bold">${formatRp(op)}</td>
                        <td class="p-4 text-right font-bold text-emerald-600">${formatRp(p)}</td>
                        <td class="p-4 text-center"><button onclick="hapus(${item.id})" class="text-red-300">âœ•</button></td>
                    </tr>`;
            });

            document.getElementById('statOmzet').innerText = formatRp(tO);
            document.getElementById('statProfitNet').innerText = formatRp(tP);
            
            const rH = (tH/tO)*100 || 0, rOp = (tOp/tO)*100 || 0, rP = (tP/tO)*100 || 0;
            document.getElementById('hppRateTxt').innerText = rH.toFixed(1) + "%";
            document.getElementById('opsRateTxt').innerText = rOp.toFixed(1) + "%";
            document.getElementById('profitRateTxt').innerText = rP.toFixed(1) + "%";
            document.getElementById('hppBar').style.width = rH + "%";
            document.getElementById('opsBar').style.width = rOp + "%";
            document.getElementById('profitBar').style.width = rP + "%";
            renderLineChart(filtered);
        }

        function hapus(id) {
            const item = salesDB.find(d => d.id === id);
            if(item) {
                masterStock[item.kategori] += item.terjual;
                salesDB = salesDB.filter(d => d.id !== id);
                localStorage.setItem('goldenMasterStock', JSON.stringify(masterStock));
                localStorage.setItem('goldenSalesDB_v4', JSON.stringify(salesDB));
                renderApp();
            }
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFillColor(0, 31, 63); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(212, 175, 55); doc.setFontSize(20); doc.text("GOLDENSALES ANALYTICS v5.5", 15, 25);
            const tableData = salesDB.map(i => [i.tgl, i.nama, i.kategori, i.terjual, formatRp(i.jual * i.terjual), formatRp((i.jual-i.hpp-i.ops)*i.terjual)]);
            doc.autoTable({ head: [['Tgl', 'Produk', 'Kategori', 'Qty', 'Omzet', 'Profit']], body: tableData, startY: 50, headStyles: { fillColor: [0, 31, 63], textColor: [212, 175, 55] } });
            doc.save(`GoldenSales_Report.pdf`);
        }
        window.onload = renderApp;
    </script>
</body>
</html>
